# 编程规范

## C++

### 工作空间结构

#### 一般目录树

```
my_cpp_project/
├── CMakeLists.txt          # 构建配置文件 (相当于 setup.py)
├── README.md
├── .gitignore              # 忽略 build/, .vscode/, *.o
├── include/                # 公共头文件 (.hpp / .h)
│   └── my_project/         # 以项目名命名，避免冲突
│       ├── main.hpp
│       └── utils.hpp
├── src/                    # 源代码实现 (.cpp)
│   ├── main.cpp
│   └── utils.cpp
├── tests/                  # 测试 (使用 GTest 或 Catch2)
│   ├── CMakeLists.txt
│   └── test_main.cpp
├── external/               # 第三方库 (Git Submodules 或源码)
└── build/                  # 编译产物目录 (不进入 Git)
```



#### 机器学习目录树

```ml_inference_cpp/
├── CMakeLists.txt
├── configs/                # 模型配置 (JSON 或 Protobuf)
├── models/                 # 序列化模型 (e.g., .onnx, .engine, .pt)
├── src/
│   ├── engine/             # 推理引擎封装
│   ├── preprocess/         # 图像处理 (OpenCV)
│   └── postprocess/        # 后处理 (NMS, TopK)
├── third_party/            # 存放预编译好的依赖库 (.so / .dll)
└── examples/               # 示例 Demo
```

### 代码规范

#### 文件与布局 (File Layout)

1. **文件后缀**：
   - 头文件：使用 `.h` 或 `.hpp`。
   - 源文件：使用 `.cpp` 或 `.cc`。
2. **自包含头文件**：头文件应该能够独立编译，即它包含了它所需要的所有其他头文件。
3. **#pragma once**：在头文件顶部使用 `#pragma once` 防止重复包含（比传统的 `#ifndef` 保护更简洁、更高效）。
4. **头文件顺序**：
   1. 对应的源文件配对头文件（如 `model.cpp` 第一行包含 `model.h`）。
   2. C 系统库（如 `<cstdio>`）。
   3. C++ 标准库（如 `<vector>`, `<string>`）。
   4. 其他库的 `.h` 文件。
   5. 本项目内的 `.h` 文件。

------

####  命名规范 (Naming Conventions)

| **对象**        | **格式**            | **示例**           | **关键说明**                       |
| --------------- | ------------------- | ------------------ | ---------------------------------- |
| **文件名**      | 小写+下划线         | `linear_model.cpp` | 避免跨平台大小写敏感问题           |
| **类名/结构体** | **大驼峰**          | `AdamOptimizer`    | 应该是名词                         |
| **函数/方法**   | **大驼峰**          | `ForwardProp()`    | Google 风格推荐，LLVM 常用小驼峰   |
| **局部变量**    | 小写+下划线         | `num_layers`       | 越短命的变量名应越短               |
| **类成员变量**  | **小写+结尾下划线** | `weights_`         | **核心**：一眼区分局部变量与成员   |
| **命名空间**    | 全小写              | `namespace dnn`    | 通常使用项目缩写                   |
| **宏/常量**     | 全大写+下划线       | `MAX_BUF_SIZE`     | 宏尽量少用，常量优先用 `constexpr` |

------

#### 内存与资源管理

1. **RAII (资源获取即初始化)**：所有的资源（内存、锁、文件）必须封装在对象中，在构造时获取，在析构时释放。
2. **智能指针**：
   - 优先使用 `std::unique_ptr`：明确所有权归属。
   - 仅在资源确实需要共享时使用 `std::shared_ptr`。
   - **禁止**：严禁直接使用 `new` 和 `delete`，除非在实现极其底层的容器。
3. **零初始化**：声明变量时务必初始化。
   - ✅ `int count = 0;`
   - ❌ `int count;` (会导致随机初值 Bug)

------

#### 函数设计规范 

1. **参数传递**：
   - **输入参数**：如果是复杂类型（类、向量、字符串），使用 **常量引用** `const T&`。
   - **输出参数**：优先使用返回值。如果必须通过参数返回，使用 **指针** `T*`（让调用者一眼看出该变量会被修改）。
2. **Const 正确性**：
   - 不修改类状态的成员函数**必须**标记为 `const`。
3. **Override 显式声明**：
   - 重写虚函数时，必须加上 `override` 关键字，防止因函数签名写错导致的静默错误。
4. **禁止隐式转换**：
   - 单参数构造函数应标记为 `explicit`，防止编译器进行危险的自动类型转换。

------

####  其他编程建议 

1. **禁止 `using namespace std;`**：这会引入数千个潜在的命名冲突，尤其在头文件中绝对禁止。

2. **优先使用 `enum class`**：代替传统的 `enum`，提供更强的类型安全和作用域限制。

3. **空指针检查**：使用 `nullptr` 而不是 `NULL` 或 `0`。

4. **范围 For 循环**：遍历容器优先使用 `for (const auto& item : container)`。

5. **初始化列表**：构造函数中优先使用初始化列表。

   C++

   ```
   // ✅ 正确：直接构造
   Layer(int units) : units_(units), bias_(0.0f) {}
   ```

------

####  注释与文档格式 

```c++
/**
 * @class Model
 * @brief 神经网络模型基类。
 */
class Model {
public:
    /**
     * @brief 执行前向计算。
     * @param input 输入张量，维度为 [N, C, H, W]。
     * @return 输出张量的指针。
     * @note 线程不安全。
     */
    virtual Tensor* Forward(const Tensor& input) = 0;
};
```

## Python

### 工作空间结构

#### 一般目录树

``````
my_python_project/
├── README.md               # 项目说明、安装指南
├── requirements.txt        # 依赖包列表 (pip install -r requirements.txt)
├── setup.py                # 打包配置 (可选，用于发布到 PyPI)
├── .gitignore              # Git 忽略文件 (e.g., __pycache__, .env)
├── .env                    # 环境变量 (e.g., API keys, 不提交到 Git)
├── src/                    # 源代码目录
│   ├── __init__.py         # 包初始化文件
│   ├── main.py             # 入口脚本
│   └── utils/              # 工具模块
│       ├── __init__.py
│       └── helpers.py
├── tests/                  # 测试目录
│   ├── __init__.py
│   ├── test_main.py        # 单元测试
│   └── conftest.py         # pytest 配置
├── docs/                   # 文档目录
│   ├── index.rst           # Sphinx 文档入口
│   └── conf.py             # Sphinx 配置
└── configs/                # 配置文件
    └── config.yaml         # YAML 格式的设置文件
``````

**说明**：

- **src/**：隔离源代码，避免与测试混淆。
- **tests/**：使用 pytest 或 unittest，保持测试独立。
- **docs/**：用 Sphinx 生成 API 文档。
- 安装依赖：pip freeze > requirements.txt 更新列表。

#### 机器学习目录树

##### **轻量版本**

```python
ml_project/
├── README.md                          # 简要说明 + 运行命令
├── requirements.txt                   # 依赖 (e.g., torch, pandas)
├── .gitignore                         # 基本忽略 (outputs/, *.pth)
├── src/
│   ├── __init__.py
│   ├── dataset.py                     # 数据加载 + 预处理
│   ├── model.py                       # 模型定义 + 损失
│   ├── train.py                       # 训练循环 + 评估
│   └── utils.py                       # 日志 + 种子
├── data/                              # 数据 (raw + processed 合并)
│   └── dataset.csv                    # 示例数据
└── outputs/                           # 输出 (checkpoints + logs 合并)
    └── model.pth                      # 示例模型
```



##### **重量版本**

```python
ml_project/
├── README.md                          # 项目概述、安装/运行指南、复现步骤
├── requirements.txt                   # 依赖 (e.g., torch, hydra-core, mlflow)
├── setup.py                           # 打包配置 (pip install -e .)
├── .gitignore                         # 忽略 __pycache__, outputs/, .env, *.pth
├── .env                               # 环境变量 (e.g., WANDB_API_KEY)
├── configs/                           # 统一配置 (用 Hydra 加载)
│   ├── default.yaml                   # 基础配置
│   └── model/                         # 模型特定配置
│       └── resnet.yaml
├── src/
│   └── ml_project/
│       ├── __init__.py
│       ├── config.py                  # 全局配置加载器 (e.g., OmegaConf)
│       ├── data/
│       │   ├── __init__.py
│       │   ├── dataset.py             # 数据集加载
│       │   └── transforms.py          # 数据增强/预处理
│       ├── models/
│       │   ├── __init__.py
│       │   ├── model.py               # 主模型定义
│       │   └── layers.py              # 自定义层
│       ├── training/
│       │   ├── __init__.py
│       │   ├── trainer.py             # 训练循环
│       │   └── losses.py              # 损失函数
│       ├── evaluation/
│       │   ├── __init__.py
│       │   └── metrics.py             # 评估指标
│       └── utils/
│           ├── __init__.py
│           ├── logger.py              # 日志 (e.g., wandb/MLflow)
│           └── seed.py                # 随机种子设置
├── scripts/
│   ├── train.py                       # 训练入口 (@hydra.main)
│   ├── eval.py                        # 评估入口
│   └── infer.py                       # 推理入口
├── notebooks/
│   └── exploration.ipynb              # Jupyter 原型开发/可视化
├── data/
│   ├── raw/                           # 原始数据 (用 DVC 跟踪)
│   ├── processed/                     # 处理后数据
│   └── external/                      # 外部数据集 (e.g., 下载的基准)
├── ops/                               # 与机器学习无关的操作，比如形态学操作 
├── experiments/
│   └── runs/                          # 实验运行记录 (MLflow artifacts)
│       └── 20260124_0127/             # 示例运行 ID
├── outputs/
│   ├── checkpoints/                   # 模型权重 (e.g., best_model.pth)
│   └── logs/                          # 训练日志/tensorboard
├── tests/
│   ├── __init__.py
│   ├── conftest.py                    # pytest 配置
│   ├── test_data/                     # 镜像 src/data/
│   │   ├── test_dataset.py
│   │   └── test_transforms.py
│   ├── test_models/                   # 镜像 src/models/
│   │   └── test_model.py
│   └── test_training/                 # 镜像 src/training/
│       └── test_trainer.py
└── docs/
    ├── index.md                       # API 文档入口 (MkDocs/Sphinx)
    └── usage.md                       # 使用指南
```

##### 



##### 文件树使用指南

**初始化**

安装环境并将 `src` 变成可调用的库：

```Bash
pip install -r requirements.txt
pip install -e .
```

 **常用指令**

| **任务** | **命令行**                                     | **备注**           |
| -------- | ---------------------------------------------- | ------------------ |
| **训练** | `python scripts/train.py`                      | 运行默认配置       |
| **调参** | `python scripts/train.py model.lr=0.01`        | 修改学习率         |
| **评估** | `python scripts/eval.py ckpt=outputs/best.pth` | 测试模型效果       |
| **测试** | `pytest`                                       | 检查代码有没有 Bug |

**文件内容**

- 逻辑写在 `src/`**：模型架构、数据处理、损失函数全放这里。**
- 参数写在 `configs/`**：不要在代码里写 `lr=0.001`，写在 `.yaml` 文件里。**
- 运行用 `scripts/`**：它是“开关”，负责调用 `src` 里的逻辑并读取 `configs`

### 代码规范PEP8（一些常用的

####  代码布局 

1. **缩进**：严格 **4个空格**。禁止混用 Tab。

2. **行宽**：限制在 **79-88** 字符。

3. **空行**：

   - 顶级函数/类定义之间：**2 行**。
   - 类内部方法 (Method) 之间：**1 行**。

4. **二元运算符换行**：在运算符 **前** 换行。

   Python

   ```
   income = (gross_wages
             + taxable_interest
             - deductions)
   ```

5. **逗号与括号**：

   - 逗号、分号、冒号前不加空格，后加空格。
   - 括号内侧不留空格：`func(x[1], {y: 2})`。

####  命名规范 

| **类别**      | **格式**              | **示例**              | **关键说明**             |
| ------------- | --------------------- | --------------------- | ------------------------ |
| **包/模块**   | 全小写                | `ml_project`, `utils` | 尽量短小，模块可用下划线 |
| **类名**      | **大驼峰 (CapWords)** | `ResNetBackbone`      | 异常类名末尾加 `Error`   |
| **函数/方法** | **小写+下划线**       | `get_loss_value()`    | 动作开头 (动词)          |
| **变量/参数** | **小写+下划线**       | `learning_rate`       | 避免单字符 `l`, `O`, `I` |
| **常量**      | **全大写+下划线**     | `BATCH_SIZE`          | 定义在模块顶层           |

####  Dunder (双下划线) 命名与使用逻辑

Dunder 方法（Magic Methods）是 Python 的内置协议，使用时必须严谨：

1. **系统保留 (System-Defined)**：
   - **准则**：仅在实现内置行为时使用（如 `__init__`, `__call__`, `__len__`）。
   - **严禁自创**：绝对不要发明 `__my_magic__` 格式的名字，这会破坏前向兼容性。

2. **名称修饰 (Name Mangling)**：
   - `__private_attr`：在类内部使用，会自动改名为 `_ClassName__private_attr`。
   - **逻辑**：仅用于防止在复杂的继承链中出现属性命名冲突，**不**作为常规“私有化”手段。

3. **位置**：魔术方法通常聚在一起，放在普通方法之前（`__init__` 永远第一）

4. Dunder清单

   | **方法**               | **触发场景** | **ML 实战用途**                              |
   | ---------------------- | ------------ | -------------------------------------------- |
   | `__init__`             | 实例化对象   | 初始化模型层、加载超参数                     |
   | `__call__`             | `obj()`      | 允许 `model(x)` 这种调用方式                 |
   | `__len__`              | `len(obj)`   | 在 `Dataset` 中返回样本总数                  |
   | `__getitem__`          | `obj[i]`     | 在 `Dataset` 中按索引加载单条数据            |
   | `__repr__`             | `repr(obj)`  | 开发调试用，控制 `print(model)` 时的显示格式 |
   | `__enter__ / __exit__` | `with` 语句  | 自动管理 GPU 显存或文件关闭                  |

   ![dunder](pics/dunder.png)

####  _前缀符号

- `_var`：**内部使用**（弱指示）。`from M import *` 不会导入此项。
- `var_`：**避开关键字**。例如 `class_='Dense'`。
- `__var`：**类私有**。触发名称修饰。
- `__var__`：**系统魔术方法**。如 `__init__`

#### 其他编程建议

1. **空值检查**远用 `is` 或 `is not`。
   - ✅ `if x is None:`
   - ❌ `if x == None:`
2. **布尔值判断**：直接判断容器，不要判断长度。
   - ✅ `if not my_list:` (判断是否为空)
   - ❌ `if len(my_list) == 0:`
   - ❌ `if x == True:`
3. **类型检查**：永远用 `isinstance()`。
   - ✅ `if isinstance(obj, list):`
   - ❌ `if type(obj) is list:`
4. **字符串操作**：使用内置前缀/后缀方法。
   - ✅ `if filename.endswith('.pth'):`
   - ❌ `if filename[-4:] == '.pth':`
5. **异常捕获**：指明具体错误，禁止空 `except:`。
   - ✅ `except ValueError:`
   - ❌ `except:` (会意外捕获 `SystemExit` 或 `KeyboardInterrupt`)

####  注释与文档 (Comments & Docstrings)

1. **行内注释**：代码后至少 **2 个空格**。
2. **块注释**：每一行以 `# ` 开头。
3. **文档字符串 (PEP 257)**：
   - 所有的公共模块、函数、类必须写 `"""Docstrings"""`。
   - **单行**：引号在一行。
   - **多行**：第一行摘要，空一行后写详细描述（包含参数 Args 和返回值 Returns）。

####  导入规范 (Imports)

1. **顺序**：
   1. 标准库（如 `os`, `sys`, `typing`）
   2. 第三方库（如 `torch`, `numpy`）
   3. 本地代码（如 `from ml_project.models import resnet`）
   
2. **原则**：
   - 每一组之间空一行。
   
   - 优先使用 **绝对导入**。
   
   - 禁止 `from module import *`
   
     

## C++和Python命名差异

| **维度**         | **Python (PEP 8 标准)**   | **C++ (Google/LLVM 标准)**           | **核心差异原因**                         |
| ---------------- | ------------------------- | ------------------------------------ | ---------------------------------------- |
| **局部变量**     | `snake_case` (小写下划线) | `snake_case` 或 `camelCase`          | C++ 视团队而定，但严禁混用               |
| **类成员变量**   | `snake_case`              | **`snake_case_` (必须带后缀下划线)** | **C++ 关键点**：防止构造函数形参遮蔽成员 |
| **常量 (Const)** | `UPPER_CASE` (全大写)     | **`kPascalCase` (k+大驼峰)**         | 区分运行时常量与预处理宏                 |
| **全局变量**     | `snake_case`              | `g_snake_case` (必须带 `g_` 前缀)    | 显式警告该变量具有全局作用域             |
| **函数/方法**    | `snake_case`              | **`PascalCase` (大驼峰)**            | C++ 中函数是重要接口，需与变量明显区分   |
| **文件名**       | `snake_case.py`           | `snake_case.cpp` / `.h`              | 保持一致，但 C++ 需区分头文件与实现      |
| **命名空间**     | N/A (靠文件夹/文件名)     | `namespace snake_case`               | C++ 必须用命名空间包裹代码以防重名       |



